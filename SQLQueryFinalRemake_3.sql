CREATE DATABASE TECNICOSUTC
GO

USE TECNICOSUTC
GO

CREATE TABLE USUARIO_INGRESO
(
ID INT IDENTITY,
Correo VARCHAR(50) NOT NULL,
Clave VARCHAR(50)NOT NULL,
Nombre VARCHAR(50) NOT NULL
CONSTRAINT pk_ID PRIMARY KEY (ID),
CONSTRAINT uq_Correo UNIQUE (Correo)
)
GO

USE [TECNICOSUTC]
GO

INSERT INTO [dbo].[USUARIO_INGRESO]
           ([Correo]
           ,[Clave]
           ,[Nombre])
     VALUES
           ('fauriciorojas05@gmail.com'
           ,'Frojas1682'
           ,'Fauricio Rojas Castro')
GO


SELECT * FROM USUARIO_INGRESO

CREATE TABLE ROLES
(
ID_ROL INT IDENTITY,
Descripcion VARCHAR(50) NOT NULL,
CONSTRAINT pk_ID_ROL PRIMARY KEY (ID_ROL),
)

INSERT INTO [dbo].[ROLES]
           ([Descripcion])
     VALUES
           ('Administrador'),('Tecnico'),('Usuario'),('Cajero')

			GO
SELECT * FROM ROLES

CREATE TABLE USUARIO_ROLES
(
IDUSUARIO INT,
IDROLES INT
CONSTRAINT FK_IDUSUARIO FOREIGN KEY (IDUSUARIO) REFERENCES USUARIO_INGRESO (ID),
CONSTRAINT FK_ID_ROLES FOREIGN KEY (IDROLES) REFERENCES ROLES (ID_ROL)
)

INSERT INTO USUARIO_ROLES VALUES (1,1)
GO
SELECT * FROM USUARIO_ROLES

CREATE TABLE USUARIOS
(
    UsuarioID int identity(1,1),
    Nombre nvarchar(50) NOT NULL,
    CorreoElectronico varchar(50),
    Telefono varchar(15) UNIQUE,
    CONSTRAINT pk_UsuarioID PRIMARY KEY (UsuarioID)
)
GO

CREATE TABLE EQUIPOS 
(
    EquipoID int identity(1,1),
    TipoEquipo nvarchar(50) NOT NULL,
    Modelo varchar(50),
    UsuarioID int,
    CONSTRAINT pk_EquipoID PRIMARY KEY (EquipoID),
    CONSTRAINT fk_UsuarioID FOREIGN KEY (UsuarioID) REFERENCES USUARIOS(UsuarioID)
)
GO

CREATE TABLE REPARACIONES
(	
	ReparacionID int identity(1,1),
	EquipoID int,
	FechaSolicitud datetime CONSTRAINT df_FechaSolicitud Default GETDATE(),
	Estado char(1),
	CONSTRAINT pk_ReparacionID PRIMARY KEY (ReparacionID),
	CONSTRAINT fk_EquipoID FOREIGN KEY (EquipoID) REFERENCES EQUIPOS(EquipoID)
)
GO

CREATE TABLE DETALLESREPARACION
(
	DetalleID int identity (1,1),
	ReparacionID int,
	Descripcion varchar(50),
	FechaIncio datetime CONSTRAINT df_FechaInicio Default GETDATE(),
	FechaFin datetime CONSTRAINT df_FechaFin Default GETDATE(),
	CONSTRAINT pk_DetalleID PRIMARY KEY (DetalleID),
	CONSTRAINT fk_Reparacion_Detalle_ID FOREIGN KEY (ReparacionID) REFERENCES REPARACIONES(ReparacionID)
)
GO

CREATE TABLE TECNICOS
(
	TecnicoID int identity(1,1),
	Nombre nvarchar(50),
	Especialidad varchar(50), 
	CONSTRAINT pk_TecnicoID PRIMARY KEY (TecnicoID)
)
GO

CREATE TABLE ASIGNACIONES
(
	AsignacionID int identity (1,1),
	ReparacionID int,
	TecnicoID int,
	FechaAsignacion datetime CONSTRAINT df_FechaAsignacion Default GETDATE(),
	CONSTRAINT pk_AsignacionID PRIMARY KEY (AsignacionID),
	CONSTRAINT fk_Reparacion_Asignacion_ID FOREIGN KEY (ReparacionID) REFERENCES REPARACIONES(ReparacionID),
	CONSTRAINT fk_Tecnico_AsignacionID FOREIGN KEY (TecnicoID) REFERENCES TECNICOS(TecnicoID)
)

GO

INSERT INTO [dbo].[USUARIOS]
           ([Nombre]
           ,[CorreoElectronico]
           ,[Telefono])
     VALUES
           ('Lorenzo Leiva','LorenzinChech@gmail.com','1930-4732'),
		    ('Camilo Montero' ,'FamomoM1019@gmail.com' ,'4634-2345'),
		    ('Victor Aymerich' ,'ZunZun@gmail.com' ,'3729-1396'),
		    ('Ian Rojas' ,'Ktiger2508@gmail.com','1320-4632'),
		   ('Isaac Gutierrez','ElIsaacPanda@gmail.com' ,'6327-8328')
GO

CREATE PROCEDURE CONSULTARUSUARIO 
AS
BEGIN
		SELECT * FROM USUARIOS
END
EXEC CONSULTARUSUARIO

GO

CREATE PROCEDURE CONSULTARUSUARIO_FILTRO
@CODIGO INT
AS
BEGIN
		SELECT * FROM USUARIOS WHERE UsuarioID = @CODIGO
END
EXEC CONSULTARUSUARIO_FILTRO 2

GO

CREATE PROCEDURE BORRARUSUARIO 
@CODIGO INT
AS
BEGIN
		DELETE USUARIOS WHERE UsuarioID = @CODIGO
END
EXEC BORRARUSUARIO 

GO 

CREATE PROCEDURE AGREGARUSUARIO	
@NOMBRE NVARCHAR(50),
@CORREO VARCHAR(50),
@TELEFONO VARCHAR(15)
AS
BEGIN
		INSERT INTO USUARIOS (Nombre,CorreoElectronico,Telefono) VALUES (@NOMBRE,@CORREO,@TELEFONO)
END
EXEC AGREGARUSUARIO 
GO

CREATE PROCEDURE MODIFICARUSUARIO
@CODIGO INT,
@NOMBRE NVARCHAR(50),
@CORREO VARCHAR(50),
@TELEFONO VARCHAR(50)
AS
BEGIN
		UPDATE USUARIOS SET Nombre = @NOMBRE WHERE UsuarioID = @CODIGO
		UPDATE USUARIOS SET CorreoElectronico = @CORREO WHERE UsuarioID = @CODIGO
		UPDATE USUARIOS SET Telefono = @TELEFONO WHERE UsuarioID = @CODIGO
END
EXEC MODIFICARUSUARIO 

GO

USE [TECNICOSUTC]
GO

INSERT INTO [dbo].[EQUIPOS] ([TipoEquipo] ,[Modelo] ,[UsuarioID])
     VALUES
           ('TV LED 50"','Samsung',1),
		   ('Microondas','Durabrand',2),
		   ('Parlante Activo #18','TOPPRO',3),
		   ('TV Plasma 51"','Panasonic',4),
		   ('TV LED 32"','Sankey',5)
GO
CREATE PROCEDURE CONSULTAREQUIPO
AS
BEGIN
		SELECT * FROM EQUIPOS
END
EXEC CONSULTAREQUIPO

GO

CREATE PROCEDURE CONSULTAREQUIPO_FILTRO
@CODIGO INT
AS
BEGIN
		SELECT * FROM EQUIPOS WHERE EquipoID = @CODIGO
END
EXEC CONSULTAREQUIPO_FILTRO 

GO

CREATE PROCEDURE BORRAREQUIPO 
@CODIGO INT
AS
BEGIN
		DELETE EQUIPOS WHERE EquipoID = @CODIGO
END
EXEC BORRAREQUIPO 

GO 

CREATE PROCEDURE AGREGAREQUIPO 
@TIPO NVARCHAR(50),
@MODELO VARCHAR(50),
@USUARIOID INT
AS
BEGIN
		INSERT INTO EQUIPOS(TipoEquipo,Modelo,UsuarioID) VALUES (@TIPO,@MODELO,@USUARIOID)
END
EXEC AGREGAREQUIPO

GO

CREATE PROCEDURE MODIFICAREQUIPO
@CODIGO INT,
@TIPO NVARCHAR(50),
@MODELO VARCHAR(50)
AS
BEGIN
		UPDATE EQUIPOS SET TipoEquipo = @TIPO WHERE EquipoID = @CODIGO
		UPDATE EQUIPOS SET Modelo = @MODELO WHERE EquipoID = @CODIGO
END
EXEC MODIFICAREQUIPO 

GO

USE [TECNICOSUTC]
GO

INSERT INTO [dbo].[REPARACIONES]
           ([EquipoID]
           ,[FechaSolicitud]
           ,[Estado])
     VALUES
           (1,GETDATE(),'A'),
		   (2,GETDATE(),'B'),
		   (3,GETDATE(),'C'),
		   (4,GETDATE(),'A'),
		   (5,GETDATE(),'A')
GO
CREATE PROCEDURE CONSULTARREPARACIONES
AS
BEGIN
		SELECT * FROM REPARACIONES
END
EXEC CONSULTARREPARACIONES

 GO

CREATE PROCEDURE BORRARREPARACION 
@CODIGO INT
AS
BEGIN
		DELETE REPARACIONES WHERE ReparacionID = @CODIGO
END
EXEC BORRARREPARACION

GO 

CREATE PROCEDURE AGREGARREPARACION 
@EQUIPOID INT,
@FECHASOLICITUD DATETIME,
@ESTADO CHAR
AS
		INSERT INTO REPARACIONES(EquipoID,FechaSolicitud,Estado) VALUES (@EQUIPOID,@FECHASOLICITUD,@ESTADO)

	EXEC AGREGARREPARACION
GO

CREATE PROCEDURE MODIFICARREPARACION
@CODIGO INT,
@FECHASOLICITUD DATETIME,
@ESTADO CHAR
AS
BEGIN
		UPDATE REPARACIONES SET FechaSolicitud = @FECHASOLICITUD WHERE ReparacionID = @CODIGO
		UPDATE REPARACIONES SET Estado = @ESTADO WHERE ReparacionID = @CODIGO
END
EXEC MODIFICARREPARACION

GO

 USE [TECNICOSUTC]
GO

INSERT INTO [dbo].[DETALLESREPARACION]
           ([ReparacionID]
           ,[Descripcion]
           ,[FechaIncio]
           ,[FechaFin])
     VALUES
           (1,'Panel quebrado, mete rayas y franjas',GETDATE() ,GETDATE()),
		   (2,'No calienta',GETDATE() ,GETDATE()),
		   (3,'Distorciona audio al subir volumen',GETDATE() ,GETDATE()),
		   (4,'No funiona, no enciende',GETDATE() ,GETDATE()),
		   (5,'No da imagen',GETDATE() ,GETDATE())
GO
CREATE PROCEDURE CONSULTAR_DETALLES_REPARACIONES
AS
BEGIN
		SELECT * FROM DETALLESREPARACION
END
EXEC CONSULTAR_DETALLES_REPARACIONES

GO

CREATE PROCEDURE BORRAR_DETALLESREPARACION 
@CODIGO INT
AS
BEGIN
		DELETE DETALLESREPARACION WHERE DetalleID = @CODIGO
END
EXEC BORRARREPARACION

GO 

CREATE PROCEDURE AGREGAR_DETALLESREPARACION 
@REPARACIONID INT,
@DESCRIPCION VARCHAR(50),
@FECHAINICIO DATETIME,
@FECHAFIN DATETIME
AS
BEGIN
		INSERT INTO DETALLESREPARACION(ReparacionID,Descripcion,FechaIncio,FechaFin) VALUES (@REPARACIONID,@DESCRIPCION,@FECHAINICIO,@FECHAFIN)
END
EXEC AGREGAR_DETALLESREPARACION

GO

CREATE PROCEDURE MODIFICAR_DETALLESREPARACION
@CODIGO INT,
@DESCRIPCION VARCHAR(50),
@FECHAINICIO DATETIME,
@FECHAFIN DATETIME
AS
BEGIN
		UPDATE DETALLESREPARACION SET Descripcion = @DESCRIPCION WHERE DetalleID = @CODIGO
		UPDATE DETALLESREPARACION SET FechaIncio = @FECHAINICIO WHERE DetalleID = @CODIGO
		UPDATE DETALLESREPARACION SET FechaFin = @FECHAFIN WHERE DetalleID = @CODIGO
END
EXEC MODIFICAR_DETALLESREPARACION
GO


USE [TECNICOSUTC]
GO

INSERT INTO [dbo].[TECNICOS]
           ([Nombre]
           ,[Especialidad])
     VALUES
           ('Deinyc Ramirez','Audio y Linea Blanca'),
		   ('Jose Mario', 'Pantallas LED y LCD'),
		   ('Christian Madriz','TV Plasma')
GO
CREATE PROCEDURE CONSULTAR_TECNICOS
AS
BEGIN
		SELECT * FROM TECNICOS
END
EXEC CONSULTAR_TECNICOS

GO

CREATE PROCEDURE CONSULTARTECNICOS_FILTRO
@CODIGO INT
AS
BEGIN
		SELECT * FROM TECNICOS WHERE TecnicoID = @CODIGO
END
EXEC CONSULTARTECNICOS_FILTRO 

GO

CREATE PROCEDURE BORRARTECNICO 
@CODIGO INT
AS
BEGIN
		DELETE TECNICOS WHERE TecnicoID = @CODIGO
END
EXEC BORRARTECNICO 

GO 

CREATE PROCEDURE AGREGARTECNICO 
@NOMBRE NVARCHAR(50),
@ESPECIALIDAD VARCHAR(50)
AS
BEGIN
		INSERT INTO TECNICOS (Nombre,Especialidad) VALUES (@NOMBRE,@ESPECIALIDAD)
END
	EXEC AGREGARTECNICO 
GO

CREATE PROCEDURE MODIFICARTECNICOS
@CODIGO INT,
@NOMBRE NVARCHAR(50),
@ESPECIALIDAD VARCHAR(50)
AS
BEGIN
		UPDATE TECNICOS SET Nombre = @NOMBRE WHERE TecnicoID = @CODIGO
		UPDATE TECNICOS SET Especialidad = @ESPECIALIDAD WHERE TecnicoID = @CODIGO
END
EXEC MODIFICARTECNICOS 

GO

USE [TECNICOSUTC]
GO

INSERT INTO [dbo].[ASIGNACIONES]
           ([ReparacionID]
           ,[TecnicoID]
           ,[FechaAsignacion])
     VALUES
           (1,2,GETDATE()),
		   (2,1,GETDATE()),
		   (3,1,GETDATE()),
		   (4,3,GETDATE()),
		   (5,2,GETDATE())
GO
CREATE PROCEDURE CONSULTAR_ASIGNACIONES
AS
BEGIN
		SELECT * FROM ASIGNACIONES
END
EXEC CONSULTAR_ASIGNACIONES

GO

CREATE PROCEDURE BORRARASIGNACION 
@CODIGO INT
AS
BEGIN
		DELETE ASIGNACIONES WHERE AsignacionID = @CODIGO
END
EXEC BORRARASIGNACION 

GO 

CREATE PROCEDURE AGREGARASIGNACION	
@REPARACIONID INT,
@TECNICOID INT,
@FECHAASIGNACION DATETIME
AS
BEGIN
	INSERT INTO ASIGNACIONES(ReparacionID,TecnicoID,FechaAsignacion) VALUES (@REPARACIONID,@TECNICOID,@FECHAASIGNACION)
END
	EXEC AGREGARASIGNACION
GO

CREATE PROCEDURE MODIFICARASIGNACION
@CODIGO INT,
@REPARACIONID INT,
@TECNICOID INT,
@FECHAASIGNACION DATETIME
AS
BEGIN
		UPDATE ASIGNACIONES SET ReparacionID = @REPARACIONID WHERE AsignacionID = @CODIGO
		UPDATE ASIGNACIONES SET TecnicoID = @TECNICOID WHERE AsignacionID = @CODIGO
		UPDATE ASIGNACIONES SET FechaAsignacion = @FECHAASIGNACION WHERE AsignacionID = @CODIGO
END
EXEC MODIFICARASIGNACION